<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LISTA DE ITENS DE PAPELARIA</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { overflow-x: hidden; }
  .decor-icon {
    position: absolute;
    width: 50px;
    height: 50px;
    opacity: 0.2;
    pointer-events: none;
    z-index: 0;
    transition: transform 2s;
  }
  .animated { animation: float 5s infinite ease-in-out; }
  @keyframes float {
    0% { transform: rotate(0deg) translateY(0px);}
    50% { transform: rotate(5deg) translateY(-5px);}
    100% { transform: rotate(0deg) translateY(0px);}
  }
</style>
</head>
<body class="bg-pink-50 min-h-screen relative">
<div id="root" class="w-full max-w-3xl mx-auto relative z-10"></div>

<script type="text/babel">
const { useState, useEffect } = React;
const { jsPDF } = window.jspdf;

const produtosIniciais = [
  { nome: "Borracha", imagem: "https://a-static.mlcdn.com.br/1500x1500/borracha-escolar-faber-castell-tk-plastica/lojamicrotec/2765p/845812bfe5cae1cc948b2f1b7c4681f1.jpeg" }
];

function App() {
  const [busca, setBusca] = useState("");
  const [buscaAtiva, setBuscaAtiva] = useState(false);
  const [sacola, setSacola] = useState([]);
  const [popupItem, setPopupItem] = useState(null);
  const [quantidade, setQuantidade] = useState(1);
  const [unidade, setUnidade] = useState("UNIDADE");
  const [nomeOutro, setNomeOutro] = useState("");
  const [previewAtivo, setPreviewAtivo] = useState(false);

  useEffect(()=>{
    const handleBeforeUnload = (e)=>{
      if(sacola.length>0){
        e.preventDefault();
        e.returnValue="Tem certeza que deseja sair? Suas alterações serão perdidas.";
      }
    };
    window.addEventListener("beforeunload",handleBeforeUnload);
    return ()=>window.removeEventListener("beforeunload",handleBeforeUnload);
  },[sacola]);

  const sugeridos = produtosIniciais.filter(p =>
    p.nome.toLowerCase().includes(busca.toLowerCase())
  );

  function adicionarNaSacola(item, qtd, uni) {
    setSacola([...sacola, { ...item, quantidade: qtd, unidade: uni }]);
  }

  function editarItem(idx, qtd, uni) {
    const novaSacola = [...sacola];
    novaSacola[idx].quantidade = qtd;
    novaSacola[idx].unidade = uni;
    setSacola(novaSacola);
  }

  function excluirItem(idx) {
    setSacola(sacola.filter((_, i) => i !== idx));
  }

  // Converte qualquer URL de imagem para base64
  async function urlParaBase64(url) {
    try {
      const response = await fetch(url);
      const blob = await response.blob();
      return await new Promise(resolve => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    } catch (e) {
      console.warn("Não foi possível carregar a imagem:", url);
      return null;
    }
  }

  async function gerarPDF() {
    const pdf = new jsPDF();
    pdf.setFontSize(16);
    pdf.text("Lista de Itens - Papelaria", 10, 15);

    let y = 30;
    const pageHeight = pdf.internal.pageSize.height;
    const imgWidth = 64;
    const imgHeight = 64;
    const gap = 1;

    for (const item of sacola) {
      let dataURL = null;
      if (item.imagem) {
        dataURL = await urlParaBase64(item.imagem);
      }

      // calcula altura do item
      let itemHeight = 0;
      if (dataURL) itemHeight += imgHeight + 5;
      const textoItem = `${item.nome} - ${item.quantidade} ${item.unidade}`;
      pdf.setFontSize(12);
      const linhas = pdf.splitTextToSize(textoItem, 120);
      itemHeight += linhas.length * 6;
      itemHeight += gap;

      if (y + itemHeight > pageHeight - 20) {
        pdf.addPage();
        y = 30;
      }

      if (dataURL) pdf.addImage(dataURL, "PNG", 10, y, imgWidth, imgHeight);

      const textX = 10 + (dataURL ? imgWidth + 10 : 0);
      const textY = y + (dataURL ? 15 : 0);
      pdf.text(linhas, textX, textY);

      y += itemHeight;
    }

    // URLs dos itens adicionados manualmente
    pdf.addPage();
    let yUrl = 20;
    pdf.setFontSize(14);
    pdf.text("URLs dos Itens Adicionados Manualmente", 10, yUrl);
    yUrl += 10;
    pdf.setFontSize(10);

    for (const item of sacola.filter(i => i.outro)) {
      const line = `{ nome: "${item.nome}", imagem: "${item.imagem || ""}"} `;
      const linhasUrl = pdf.splitTextToSize(line, 180);
      pdf.text(linhasUrl, 10, yUrl);
      yUrl += 6 * linhasUrl.length;
      if (yUrl > pageHeight - 20) {
        pdf.addPage();
        yUrl = 20;
      }
    }

    return pdf;
  }

  async function baixarPDF() {
    const pdf = await gerarPDF();
    pdf.save("ListaDeItens.pdf");
  }

  async function compartilharPDF() {
    const pdf = await gerarPDF();
    const blob = pdf.output("blob");
    const file = new File([blob],"ListaDeItens.pdf",{type:"application/pdf"});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      try{
        await navigator.share({files:[file],title:"Lista de Itens",text:"Confira a lista de itens"});
      }catch(e){
        alert("Erro ao compartilhar: "+e);
      }
    } else {
      alert("Compartilhamento não suportado nesse dispositivo.");
    }
  }

  return (
    <div className="relative w-full px-2 sm:px-4 z-10">
      <h1 className="text-center font-bold text-2xl mb-4 text-pink-700">LISTA DE ITENS DE PAPELARIA</h1>

      <div className="mb-4 flex justify-center">
        <input value={busca} onChange={e=>setBusca(e.target.value)} placeholder="Buscar item..." className="border rounded px-3 py-2 w-full max-w-xl" onFocus={()=>setBuscaAtiva(true)} onBlur={()=>setTimeout(()=>setBuscaAtiva(false),200)}/>
      </div>

      <div className="mb-4 flex flex-col gap-1">
        {buscaAtiva && sugeridos.map((p,i)=>(
          <div key={i} className="cursor-pointer flex items-center gap-2 p-2 bg-white rounded shadow" onClick={()=>{setPopupItem({...p}); setQuantidade(1); setUnidade("UNIDADE");}}>
            {p.imagem && <img src={p.imagem} alt={p.nome} className="w-10 h-10 sm:w-12 sm:h-12" />}
            {p.nome}
          </div>
        ))}
      </div>

      <div className="flex flex-col sm:flex-row gap-2 mb-6">
        <button onClick={()=>{setPopupItem({outro:true,nome:"",imagem:"",categoria:"OUTROS", url:""}); setQuantidade(1); setUnidade("UNIDADE"); setNomeOutro("");}} className="bg-pink-500 text-white px-4 py-2 rounded flex-1">ADICIONAR OUTRO ITEM</button>
        <button onClick={()=>setPreviewAtivo(true)} className="bg-pink-700 text-white px-4 py-2 rounded flex-1">CONFERIR E ENVIAR</button>
      </div>

      <h2 className="mt-6 mb-2 font-bold text-lg text-pink-700">Minha Sacola</h2>
      <div className="flex flex-col gap-2">
        {sacola.map((i,idx)=>(
          <div key={idx} className="flex items-center gap-2 bg-white p-2 rounded shadow flex-wrap sm:flex-nowrap justify-between">
            <div className="flex items-center gap-2">
              {i.imagem && <img src={i.imagem} alt={i.nome} className="w-10 h-10 sm:w-12 sm:h-12"/>}
              <span>{i.nome} - {i.quantidade} {i.unidade}</span>
            </div>
            <div className="flex gap-2">
              <button className="bg-pink-500 text-white px-2 py-1 rounded" onClick={()=>{setPopupItem({...i,idx}); setQuantidade(i.quantidade); setUnidade(i.unidade); setNomeOutro(i.nome);}}>Editar</button>
              <button className="bg-gray-400 text-white px-2 py-1 rounded" onClick={()=>excluirItem(idx)}>Excluir</button>
            </div>
          </div>
        ))}
      </div>

      {/* Modal */}
      {popupItem && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50 p-2">
          <div className="bg-white p-4 sm:p-6 rounded shadow w-full max-w-xs sm:max-w-sm relative overflow-hidden">
            <h3 className="font-bold mb-2">{popupItem.outro ? "Adicionar Item" : popupItem.nome}</h3>

            {!popupItem.outro && popupItem.imagem && (
              <img src={popupItem.imagem} alt={popupItem.nome} className="w-16 h-16 mx-auto mb-2"/>
            )}

            {popupItem.outro && (
              <input
                value={nomeOutro}
                onChange={e => setNomeOutro(e.target.value)}
                placeholder="Nome do item"
                className="border w-full p-2 mb-2"
              />
            )}

            <select
              className="border w-full p-2 mb-2"
              value={quantidade}
              onChange={e => setQuantidade(e.target.value)}
            >
              {Array.from({ length: 50 }, (_, i) => i + 1).map(n => (
                <option key={n} value={n}>{n}</option>
              ))}
            </select>

            <select
              className="border w-full p-2 mb-2"
              value={unidade}
              onChange={e => setUnidade(e.target.value)}
            >
              <option>UNIDADE</option>
              <option>CONJUNTO</option>
              <option>CAIXA</option>
              <option>PACOTE</option>
            </select>

            {popupItem.outro && (
              <input
                value={popupItem.url || ""}
                onChange={e => setPopupItem({ ...popupItem, url: e.target.value })}
                placeholder="URL da imagem"
                className="border w-full p-2 mb-2"
              />
            )}

            <div className="flex flex-col sm:flex-row justify-between gap-2">
              <button
                className="bg-gray-400 text-white px-4 py-2 rounded flex-1"
                onClick={() => setPopupItem(null)}
              >
                Cancelar
              </button>
              <button
                className="bg-pink-600 text-white px-4 py-2 rounded flex-1"
                onClick={() => {
                  if (popupItem.idx !== undefined) {
                    editarItem(popupItem.idx, quantidade, unidade);
                  } else if (popupItem.outro) {
                    adicionarNaSacola({
                      ...popupItem,
                      nome: nomeOutro,
                      imagem: popupItem.url || ""
                    }, quantidade, unidade);
                  } else {
                    adicionarNaSacola(popupItem, quantidade, unidade);
                  }
                  setPopupItem(null);
                }}
              >
                {popupItem.idx !== undefined ? "Salvar" : "Adicionar à Sacola"}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Pré-visualização */}
      {previewAtivo && (
        <div className="fixed inset-0 bg-pink-50 z-50 p-4 overflow-auto">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-pink-700 font-bold text-xl">Pré-visualização da Lista</h2>
            <div className="flex gap-2">
              <button onClick={baixarPDF} className="bg-pink-600 text-white px-4 py-2 rounded">Baixar PDF</button>
              <button onClick={compartilharPDF} className="bg-pink-500 text-white px-4 py-2 rounded">Compartilhar</button>
              <button onClick={() => setPreviewAtivo(false)} className="bg-gray-400 text-white px-4 py-2 rounded">Fechar</button>
            </div>
          </div>

          <div className="bg-white p-4 rounded shadow flex flex-col gap-2">
            {sacola.map((i,j)=> (
              <div key={j} className="flex items-center gap-2 p-1">
                {i.imagem && <img src={i.imagem} className="w-8 h-8"/>}
                <span>{i.nome} - {i.quantidade} {i.unidade}</span>
              </div>
            ))}
            {sacola.length === 0 && <p className="text-gray-500">Nenhum item na sacola.</p>}
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
