<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LISTA DE ITENS DE PAPELARIA</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { overflow-x: hidden; }
  .decor-icon {
    position: absolute;
    width: 50px;
    height: 50px;
    opacity: 0.2;
    pointer-events: none;
    z-index: 0;
    transition: transform 2s;
  }
  .animated { animation: float 5s infinite ease-in-out; }
  @keyframes float {
    0% { transform: rotate(0deg) translateY(0px);}
    50% { transform: rotate(5deg) translateY(-5px);}
    100% { transform: rotate(0deg) translateY(0px);}
  }
</style>
</head>
<body class="bg-pink-50 min-h-screen relative">
<div id="root" class="w-full max-w-3xl mx-auto relative z-10"></div>

<!-- Ícones decorativos -->
<img src="https://cdn-icons-png.flaticon.com/512/5956/5956881.png" class="decor-icon animated" style="top:5%; left:5%"/>
<img src="https://i.pinimg.com/736x/5b/1a/1f/5b1a1fe80409c15862ab918fc49e0854.jpg" class="decor-icon animated" style="top:15%; left:80%"/>
<img src="https://cdn-icons-png.flaticon.com/512/5956/5956881.png" class="decor-icon animated" style="top:50%; left:10%"/>
<img src="https://www.tudodesenhos.com/uploads/images/1784/tesoura-sem-pontas.jpg" class="decor-icon animated" style="top:30%; left:50%"/>
<img src="https://i.pinimg.com/736x/5b/1a/1f/5b1a1fe80409c15862ab918fc49e0854.jpg" class="decor-icon animated" style="top:60%; left:75%"/>
<img src="https://cdn-icons-png.flaticon.com/512/5956/5956881.png" class="decor-icon animated" style="top:40%; left:80%"/>

<script type="text/babel">
const { useState, useEffect } = React;
const { jsPDF } = window.jspdf;

// Produtos iniciais sem link da caneta
const produtosIniciais = [
  { nome: "Borracha", imagem: "https://a-static.mlcdn.com.br/1500x1500/borracha-escolar-faber-castell-tk-plastica/lojamicrotec/2765p/845812bfe5cae1cc948b2f1b7c4681f1.jpeg" }
];

function App() {
  const [busca, setBusca] = useState("");
  const [buscaAtiva, setBuscaAtiva] = useState(false);
  const [sacola, setSacola] = useState([]);
  const [popupItem, setPopupItem] = useState(null);
  const [quantidade, setQuantidade] = useState(1);
  const [unidade, setUnidade] = useState("UNIDADE");
  const [nomeOutro, setNomeOutro] = useState("");
  const [previewAtivo, setPreviewAtivo] = useState(false);

  useEffect(()=>{
    const handleBeforeUnload = (e)=>{
      if(sacola.length>0){
        e.preventDefault();
        e.returnValue="Tem certeza que deseja sair? Suas alterações serão perdidas.";
      }
    };
    window.addEventListener("beforeunload",handleBeforeUnload);
    return ()=>window.removeEventListener("beforeunload",handleBeforeUnload);
  },[sacola]);

  const sugeridos = produtosIniciais.filter(p =>
    p.nome.toLowerCase().includes(busca.toLowerCase())
  );

  function adicionarNaSacola(item, qtd, uni) {
    setSacola([...sacola, { ...item, quantidade: qtd, unidade: uni }]);
  }

  function editarItem(idx, qtd, uni) {
    const novaSacola = [...sacola];
    novaSacola[idx].quantidade = qtd;
    novaSacola[idx].unidade = uni;
    setSacola(novaSacola);
  }

  function excluirItem(idx) {
    setSacola(sacola.filter((_, i) => i !== idx));
  }

  async function gerarPDF() {
    const pdf = new jsPDF();
    pdf.setFontSize(16);
    pdf.text("Lista de Itens - Papelaria", 10, 15);

    let y = 30;
    let itemCount = 0;
    const imgWidth = 64;
    const imgHeight = 64;

    for (const item of sacola) {
      if (itemCount === 3) {
        pdf.addPage();
        y = 30;
        itemCount = 0;
      }

      let dataURL = null;
      if (item.imagem) {
        dataURL = await new Promise(resolve => {
          const img = new Image();
          img.crossOrigin = "Anonymous";
          img.src = item.imagem;
          img.onload = () => {
            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL("image/png"));
          };
          img.onerror = async () => {
            try {
              const response = await fetch(item.imagem);
              const blob = await response.blob();
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.readAsDataURL(blob);
            } catch (e) { resolve(null); }
          };
        });
      }

      if (dataURL) pdf.addImage(dataURL, "PNG", 10, y, imgWidth, imgHeight);

      const textX = 10 + imgWidth + 10;
      const textY = y + 15;
      const textoItem = `${item.nome} - ${item.quantidade} ${item.unidade}`;
      pdf.setFontSize(12);
      const linhas = pdf.splitTextToSize(textoItem, 120);
      pdf.text(linhas, textX, textY);

      y += imgHeight + 15;
      itemCount++;
    }

    return pdf;
  }

  async function baixarPDF() {
    const pdf = await gerarPDF();
    pdf.save("ListaDeItens.pdf");
  }

  async function compartilharPDF() {
    const pdf = await gerarPDF();
    const blob = pdf.output("blob");
    const file = new File([blob],"ListaDeItens.pdf",{type:"application/pdf"});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      try{
        await navigator.share({files:[file],title:"Lista de Itens",text:"Confira a lista de itens"});
      }catch(e){
        alert("Erro ao compartilhar: "+e);
      }
    } else {
      alert("Compartilhamento não suportado nesse dispositivo.");
    }
  }

  return (
    <div className="relative w-full px-2 sm:px-4 z-10">
      <h1 className="text-center font-bold text-2xl mb-4 text-pink-700">LISTA DE ITENS DE PAPELARIA</h1>

      <div className="mb-4 flex justify-center">
        <input value={busca} onChange={e=>setBusca(e.target.value)} placeholder="Buscar item..." className="border rounded px-3 py-2 w-full max-w-xl" onFocus={()=>setBuscaAtiva(true)} onBlur={()=>setTimeout(()=>setBuscaAtiva(false),200)}/>
      </div>

      <div className="mb-4 flex flex-col gap-1">
        {buscaAtiva && sugeridos.map((p,i)=>(
          <div key={i} className="cursor-pointer flex items-center gap-2 p-2 bg-white rounded shadow" onClick={()=>{setPopupItem({...p}); setQuantidade(1); setUnidade("UNIDADE");}}>
            {p.imagem && <img src={p.imagem} alt={p.nome} className="w-10 h-10 sm:w-12 sm:h-12" />}
            {p.nome}
          </div>
        ))}
      </div>

      <div className="flex flex-col sm:flex-row gap-2 mb-6">
        <button onClick={()=>{setPopupItem({outro:true,nome:"",imagem:"",categoria:"OUTROS", url:""}); setQuantidade(1); setUnidade("UNIDADE"); setNomeOutro("");}} className="bg-pink-500 text-white px-4 py-2 rounded flex-1">ADICIONAR OUTRO ITEM</button>
        <button onClick={()=>setPreviewAtivo(true)} className="bg-pink-700 text-white px-4 py-2 rounded flex-1">CONFERIR E ENVIAR</button>
      </div>

      <h2 className="mt-6 mb-2 font-bold text-lg text-pink-700">Minha Sacola</h2>
      <div className="flex flex-col gap-2">
        {sacola.map((i,idx)=>(
          <div key={idx} className="flex items-center gap-2 bg-white p-2 rounded shadow flex-wrap sm:flex-nowrap justify-between">
            <div className="flex items-center gap-2">
              {i.imagem && <img src={i.imagem} alt={i.nome} className="w-10 h-10 sm:w-12 sm:h-12"/>}
              <span>{i.nome} - {i.quantidade} {i.unidade}</span>
            </div>
            <div className="flex gap-2">
              <button className="bg-pink-500 text-white px-2 py-1 rounded" onClick={()=>{setPopupItem({...i,idx}); setQuantidade(i.quantidade); setUnidade(i.unidade); setNomeOutro(i.nome);}}>Editar</button>
              <button className="bg-gray-400 text-white px-2 py-1 rounded" onClick={()=>excluirItem(idx)}>Excluir</button>
            </div>
          </div>
        ))}
      </div>

      {/* Modal e Pré-visualização serão iguais, com select de 1 a 100 */}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
